/*ko.viewmodel.js - version 2.0.3
 * Copyright 2013, Dave Herren http://coderenaissance.github.com/knockout.viewmodel/
 * License: MIT (http://www.opensource.org/licenses/mit-license.php)*/
/*jshint eqnull:true, boss:true, loopfunc:true, evil:true, laxbreak:true, undef:true, unused:true, browser:true, immed:true, devel:true, sub: true, maxerr:50 */
/*global ko:false */
(function(e){if(typeof require==="function"&&typeof exports==="object"&&typeof module==="object"){e(require("knockout"),exports)}else if(typeof define==="function"&&define["amd"]){define(["knockout","exports"],e)}else{e(ko,ko.viewmodel={})}})(function(e,t){function l(e,t){var n=e?e[t.full]||e[t.parent]||e[t.name]||{}:{};if(u)u(t,n,e);return n}function c(e){var t={},n=e?e.shared||{}:{},r,i,s,o,u,a,f,l;for(a in e){r=e[a]||{};if(a==="shared")continue;else if(r instanceof Array){for(s=0,u=r.length;s<u;s++){o=r[s];t[o]=t[o]||{};t[o][a]=true;t[o].settingType=t[o].settingType?"multiple":a}}else if(r.constructor===Object){for(o in r){t[o]=t[o]||{};i=r[o];i=a!=="arrayChildId"&&i&&i.constructor===String&&n[i]?n[i]:i;if(i&&i.constructor===Object){for(f in i){if((l=i[f])&&l.constructor==String&&n[l]){i[f]=n[l]}}}t[o][a]=i;t[o].settingType=t[o].settingType?"multiple":a}}}return t}function h(e){return e===null||e===undefined}function p(e){return e===null||e===undefined||e.constructor===String||e.constructor===Number||e.constructor===Boolean||e instanceof Date}function d(e,t,n,r){var o,u,c,m,g,y,b,w,E,S,x;r=r||l(t,n);if(b=r.custom){E=true;if(typeof b==="function"){u=b(e);if(!h(u)){u.___$mapCustom=b}}else{u=b.map(e);if(!h(u)){u.___$mapCustom=b.map;if(b.unmap){u.___$unmapCustom=b.unmap}}}}else if(r.append){E=true;u=e}else if(r.exclude){E=true;return f}else if(p(e)){u=n.parentIsArray?e:i(e)}else if(e instanceof Array){u=[];for(c=0,m=e.length;c<m;c++){u[c]=d(e[c],t,{name:"[i]",parent:n.name+"[i]",full:n.full+"[i]",parentIsArray:true})}if(!n.parentIsArray||a){y={name:"[i]",parent:n.name+"[i]",full:n.full+"[i]",parentIsArray:true};u=s(u);if(g=r.arrayChildId){u.___$childIdName=g}u.pushFromModel=function(e){e=d(e,t,y);u.push(e)};u.unshiftFromModel=function(e){e=d(e,t,y);u.unshift(e)};u.popToModel=function(e){e=u.pop();return v(e,y)};u.shiftToModel=function(e){e=u.shift();return v(e,y)}}}else if(e.constructor===Object){u={};for(c in e){y={name:c,parent:(n.name==="[i]"?n.parent:n.name)+"."+c,full:n.full+"."+c};x=e[c];S=p(x)?l(t,y):undefined;if(S&&S.custom){u.___$customChildren=u.___$customChildren||{};u.___$customChildren[c]=S.custom;if(typeof S.custom==="function"){u[c]=S.custom(e[c])}else{u[c]=S.custom.map(e[c])}}else{o=d(x,t,y,S);if(o!==f){u[c]=o}}}}if(!E&&(w=r.extend)){if(typeof w==="function"){u=w(u)||u}else if(w.constructor===Object){if(typeof w.map==="function"){u=w.map(u)||u}if(typeof w.unmap==="function"){u.___$unmapExtend=w.unmap}}}return u}function v(t,r){var i,s,o,a,l=n(t),c,d,m=t!==l;if(u){u(r)}if(!m&&t&&t.constructor===Function){return f}else if(t&&t.___$unmapCustom){i=t.___$unmapCustom(t)}else if(m&&p(l)||h(l)){i=l}else if(l instanceof Array){i=[];for(s=0,o=l.length;s<o;s++){i[s]=v(l[s],{name:"[i]",parent:r.name+"[i]",full:r.full+"[i]"})}}else if(l.constructor===Object){i={};for(s in l){if(s.substr(0,4)!=="___$"){if(t.___$customChildren&&t.___$customChildren[s]&&t.___$customChildren[s].unmap){i[s]=t.___$customChildren[s].unmap(l[s])}else{c=l[s];if(!e.isComputed(c)&&!((a=n(c))&&a.constructor===Function)){d=v(c,{name:s,parent:(r.name==="[i]"?r.parent:r.name)+"."+s,full:r.full+"."+s});if(d!==f){i[s]=d}}}}}}else{if(!m&&typeof l!=="function"){i=l}}if(t&&t.___$unmapExtend){i=t.___$unmapExtend(i,t)}return i}function m(t,i,s,o,a){var f,l,c,d,v,g,y,b,w=n(i),E=i!==w,S,x,T,N,C,k,L;if(u){u(s)}if(E&&h(w)^h(t)){i(t)}else if(t&&w&&w.constructor==Object&&t.constructor===Object){for(f in t){if(i.___$customChildren&&i.___$customChildren[f]){C=i.___$customChildren[f].map||i.___$customChildren[f];w[f]=C(t[f])}else{S=w[f];if(!E&&w.hasOwnProperty(f)&&(p(S)||S&&S.constructor===Array)){w[f]=t[f]}else if(S&&typeof S.___$mapCustom==="function"){if(r(S)){N=S.___$mapCustom(t[f],S);N=n(N);S(N)}else{w[f]=S.___$mapCustom(t[f],S)}}else if(h(t[f])&&w[f]&&w[f].constructor===Object){w[f]=t[f]}else{if(!!a){var A=function(e,t,n){return function(){m(e[n],w[n],{name:n,parent:(s.name==="[i]"?s.parent:s.name)+"."+n,full:s.full+"."+n},w,a);a(a()-1)}}(t,i,f);a(a()+1);setTimeout(A,0)}else{m(t[f],w[f],{name:f,parent:(s.name==="[i]"?s.parent:s.name)+"."+f,full:s.full+"."+f})}}}}}else if(w&&w instanceof Array){if(y=i.___$childIdName){c=[];d=[];for(f=t.length-1;f>=0;f--){v=t[f][y];for(l=w.length-1;l>=0;l--){S=w[l];k=n(S);g=n(k[y]);if(g===v){if(S.___$mapCustom){if(e.isObservable(S)){L=S.___$mapCustom(t[f],S);if(r(L)&&L!=S){S(n(L))}}else{w[l]=S.___$mapCustom(t[f],S)}}else{if(!!a){var O=function(e,t,n,r){return function(){m(e[n],w[r],{name:"[i]",parent:s.name+"[i]",full:s.full+"[i]"},undefined,a);a(a()-1)}}(t,i,f,l);a(a()+1);setTimeout(O,0)}else{m(t[f],w[l],{name:"[i]",parent:s.name+"[i]",full:s.full+"[i]"})}}d[l]=true;c[f]=true;break}}}for(l=w.length-1;l>=0;l--){if(!d[l]){i.splice(l,1)}}for(f=t.length-1;f>=0;f--){if(!c[f]){i.pushFromModel(t[f])}}}else{T=[];x=i.___$mapCustom;if(typeof x==="function"){for(f=0,b=t.length;f<b;f++){T[f]=t[f]}i(x(T))}else{i(T);for(f=0,b=t?t.length:0;f<b;f++){i.pushFromModel(t[f])}}}}else if(E){i(t)}if(s.name==="{root}"&&!!a){return{onComplete:function(t){if(t&&typeof t=="function"){if(!!a){e.computed(function(){if(t&&a()===0){t();t=undefined}}).extend({throttle:50})}else{t()}}}}}}function g(e,t){a=e.makeChildArraysObservable;if(window.console&&e.logging){console.log(t);u=function(t,n,r){var i;if(n&&n.settingType){i=n.settingType+" "+t.full+" (matched: '"+((r[t.full]?t.full:"")||(r[t.parent]?t.parent:"")||t.name)+"')"}else{i="default "+t.full}console.log("- "+i)}}else{u=undefined}}var n=e.utils.unwrapObservable,r=e.isObservable,i=e.observable,s=e.observableArray,o={name:"{root}",parent:"{root}",full:"{root}"},u,a,f=function(){};e.viewmodel={options:{makeChildArraysObservable:true,logging:false},fromModel:function(t,n){var r=c(n);g(this.options,"Mapping From Model");return d(t,r,o)},toModel:function(t){g(this.options,"Mapping To Model");return v(t,o)},updateFromModel:function(n,r,i){var s=i?e.observable(0):undefined;g(this.options,"Update From Model");return m(r,n,o,undefined,s)}}})